# ==============================================================================
# نسخه: 0.20
# فایل: auth_utils.py
# تهیه کننده: ------
# توضیح توابع و ماژول های استفاده شده در برنامه:
# این ماژول وظایف مربوط به امنیت سیستم را بر عهده دارد.
# شامل توابعی برای هش کردن رمزهای عبور (SHA-256) جهت ذخیره‌سازی ایمن 
# و همچنین تجزیه و تحلیل (Parse) بازگشتی سطوح دسترسی کاربران از فرمت JSON به دیکشنری.
# ==============================================================================

import hashlib
import json

# ------------------------------------------------------------------------------
# [تگ: هش کردن رمز عبور]
# این تابع یک رشته متنی (رمز عبور) را دریافت کرده و با استفاده از الگوریتم SHA-256
# آن را به یک هش ۶۴ کاراکتری غیرقابل بازگشت تبدیل می‌کند.
# ------------------------------------------------------------------------------
def hash_password(password: str) -> str:
    """تبدیل رمز عبور متنی به فرمت هش شده برای افزایش امنیت دیتابیس"""
    return hashlib.sha256(password.encode()).hexdigest()

# ------------------------------------------------------------------------------
# [تگ: تحلیل سطوح دسترسی]
# این تابع داده‌های مربوط به دسترسی کاربران را که ممکن است به صورت رشته JSON
# تو در تو ذخیره شده باشند، به صورت بازگشتی پردازش کرده و یک دیکشنری استاندارد برمی‌گرداند.
# ------------------------------------------------------------------------------
def parse_permissions_recursive(data, depth=0):
    """تجزیه و تحلیل بازگشتی سطوح دسترسی کاربران جهت اطمینان از صحت فرمت داده"""
    # جلوگیری از ایجاد حلقه‌های بی‌نهایت در صورت وجود داده‌های مخرب
    if depth > 3: return {}
    if data is None: return {}
    
    # اگر داده از قبل دیکشنری باشد، مستقیماً بازگردانده می‌شود
    if isinstance(data, dict): return data
    
    # اگر داده رشته باشد، تلاش برای تبدیل آن از JSON به دیکشنری
    if isinstance(data, str):
        cleaned = data.strip()
        # مدیریت رشته‌های خالی یا مقادیر نال
        if not cleaned or cleaned.lower() == "null" or cleaned == "{}": return {}
        try:
            parsed = json.loads(cleaned)
            # اگر پس از پارس کردن باز هم رشته بود، یک مرحله دیگر پردازش انجام می‌شود
            if isinstance(parsed, str): 
                return parse_permissions_recursive(parsed, depth + 1)
            elif isinstance(parsed, dict): 
                return parsed
            else: 
                return {}
        except json.JSONDecodeError: 
            return {}
            
    return {}