# ==============================================================================
# نسخه: 0.20
# فایل: warehouse_app.py
# تهیه کننده: ------
# توضیح توابع و ماژول های استفاده شده در برنامه:
# این فایل هسته مرکزی و نقطه ورود (Entry Point) اپلیکیشن است.
# وظایف اصلی آن شامل پیکربندی سرور Flask، مدیریت پوشه‌های سیستمی،
# فراخوانی توابع مقداردهی اولیه دیتابیس، ثبت مسیرهای API و در نهایت
# اجرای همزمان سرویس نظارتی (Watchdog) و باز کردن مرورگر کلاینت می‌باشد.
# ==============================================================================

import logging
import os
import time
import threading
import webbrowser
from flask import Flask
from flask_cors import CORS

# ایمپورت ماژول‌های داخلی پروژه جهت پیکربندی و اجرا
from config import API_PORT, UPLOAD_FOLDER, BACKUP_FOLDER, SERVER_URL, HEARTBEAT_TIMEOUT
from database import init_db
from routes import register_routes
from services import watchdog_service

# ------------------------------------------------------------------------------
# [تگ: پیکربندی اپلیکیشن Flask]
# تنظیم مسیر فایل‌های استاتیک و فعال‌سازی قابلیت CORS برای دسترسی‌های بین دامنه.
# ------------------------------------------------------------------------------
app = Flask(__name__, static_folder='static', static_url_path='/static')
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
CORS(app)

# تنظیمات لاگ سرور: جهت کاهش شلوغی کنسول، فقط خطاهای سطح ERROR نمایش داده می‌شوند.
log = logging.getLogger('werkzeug')
log.setLevel(logging.ERROR)

# ------------------------------------------------------------------------------
# [تگ: مدیریت وضعیت سرور]
# متغیری برای ذخیره زمان آخرین سیگنال زنده بودن کلاینت و وضعیت خاموش شدن.
# ------------------------------------------------------------------------------
server_state = {
    "last_heartbeat": time.time(),
    "shutdown_trigger": False
}

# ------------------------------------------------------------------------------
# [تگ: تابع راه‌اندازی اپلیکیشن]
# این تابع زنجیره‌ای از عملیات پیش‌نیاز را برای اجرای صحیح برنامه انجام می‌دهد.
# ------------------------------------------------------------------------------
def start_app():
    """آماده‌سازی محیط و اجرای کامل سرویس‌های برنامه"""
    
    # ۱. ایجاد پوشه‌های مورد نیاز (آپلود و بک‌آپ) در صورت عدم وجود
    for folder in [UPLOAD_FOLDER, BACKUP_FOLDER]:
        os.makedirs(folder, exist_ok=True)

    # ۲. مقداردهی اولیه دیتابیس (ساخت جداول و مهاجرت داده‌ها)
    init_db()

    # ۳. ثبت تمامی مسیرهای API و نقاط پایانی تعریف شده در ماژول روت
    register_routes(app, server_state)

    # ۴. راه‌اندازی سرویس نظارتی (Watchdog) در یک ترد جداگانه (Daemon)
    # این سرویس در صورت بسته شدن کلاینت، سرور را متوقف می‌کند.
    threading.Thread(target=watchdog_service, args=(server_state, HEARTBEAT_TIMEOUT), daemon=True).start()

    # ۵. باز کردن خودکار رابط کاربری در مرورگر پیش‌فرض سیستم
    try:
        webbrowser.open(SERVER_URL)
    except Exception as e:
        print(f"Could not open browser: {e}")

    # ۶. اجرای سرور Flask روی پورت تعیین شده در تنظیمات
    # استفاده از threaded=True برای مدیریت درخواست‌های همزمان
    app.run(port=API_PORT, debug=False, use_reloader=False, threaded=True)

# ------------------------------------------------------------------------------
# [تگ: نقطه شروع اجرا]
# بررسی اینکه فایل مستقیماً اجرا شده است و فراخوانی تابع شروع.
# ------------------------------------------------------------------------------
if __name__ == '__main__':
    start_app()