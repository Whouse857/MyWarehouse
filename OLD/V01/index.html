<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم انبار نکسوس</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <script>
        tailwind.config = { theme: { extend: { colors: { nexus: { bg: '#0f172a', card: '#1e293b', input: '#020617', border: '#334155', primary: '#6366f1', accent: '#0ea5e9', success: '#10b981', danger: '#ef4444' } }, fontFamily: { sans: ['Vazirmatn', 'sans-serif'] } } } }
    </script>
    <style>
        body { background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e1b4b 100%); color: #e2e8f0; height: 100vh; overflow: hidden; }
        #root { height: 100%; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .nexus-input { background-color: rgba(2, 6, 23, 0.5); border: 1px solid #334155; color: #f8fafc; border-radius: 0.5rem; transition: all 0.2s; }
        .nexus-input:focus { border-color: #6366f1; background-color: rgba(2, 6, 23, 0.8); outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .nexus-input:disabled { opacity: 0.5; cursor: not-allowed; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .ping-slow { animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite; }
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;
        const API_URL = "http://127.0.0.1:8090/api";
        const getJalaliDate = () => new Date().toLocaleDateString('fa-IR');
        const formatNumberWithCommas = (v) => v ? String(v).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "";

        // --- هوک سفارشی برای رندر مجدد آیکون‌ها ---
        // این هوک تضمین می‌کند هر بار دیتای صفحه تغییر کرد، آیکون‌ها دوباره رسم شوند
        const useLucide = (dependencies) => {
            useEffect(() => {
                if (window.lucide) {
                    // یک تاخیر بسیار کوتاه برای اطمینان از اینکه React رندر DOM را تمام کرده است
                    setTimeout(() => window.lucide.createIcons(), 10);
                }
            }, dependencies);
        };

        // --- UI Components ---
        const NexusInput = ({ label, value, onChange, placeholder, dir="ltr", type="text", className="", list, disabled, onKeyPress }) => (
            <div className={`flex flex-col ${className}`}>
                {label && <label className="text-gray-400 text-xs mb-1 block font-medium">{label}</label>}
                <input type={type} value={value} onChange={onChange} onKeyPress={onKeyPress} dir={dir} placeholder={placeholder} list={list} disabled={disabled} className="nexus-input w-full px-3 py-2 text-sm placeholder-gray-500" />
            </div>
        );
        const NexusSelect = ({ label, options, value, onChange, className="", disabled }) => (
            <div className={`flex flex-col ${className}`}>
                <label className="text-gray-400 text-xs mb-1 block font-medium">{label}</label>
                <div className="relative">
                    <select value={value} onChange={onChange} disabled={disabled} className="nexus-input w-full px-3 py-2 text-sm appearance-none cursor-pointer disabled:cursor-not-allowed" dir="ltr">
                        <option value="" className="bg-slate-900 text-gray-400">...</option>
                        {options.map(opt => <option key={opt} value={opt} className="bg-slate-900">{opt}</option>)}
                    </select>
                    <i data-lucide="chevron-down" className="absolute left-2 top-2.5 w-4 h-4 text-gray-500 pointer-events-none"></i>
                </div>
            </div>
        );

        // --- Pages ---
        const LoginPage = ({ onLogin }) => {
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);
            
            useLucide([]); // رندر اولیه آیکون‌ها

            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError("");
                try {
                    const res = await fetch(`${API_URL}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ username, password }) });
                    const data = await res.json();
                    if (data.success) onLogin(data); else setError(data.message || "خطا در ورود");
                } catch (err) { setError("خطا در اتصال به سرور"); } finally { setLoading(false); }
            };
            return (
                <div className="flex h-screen items-center justify-center">
                    <div className="glass-panel p-8 rounded-2xl w-full max-w-md shadow-2xl border border-white/10">
                        <div className="flex justify-center mb-6"><h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">NEXUS</h1></div>
                        <h2 className="text-xl font-bold text-white text-center mb-6">ورود به سیستم انبار</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <NexusInput label="نام کاربری" value={username} onChange={e=>setUsername(e.target.value)} dir="ltr" className="text-center" />
                            <NexusInput label="رمز عبور" type="password" value={password} onChange={e=>setPassword(e.target.value)} dir="ltr" className="text-center" />
                            {error && <div className="text-nexus-danger text-sm text-center">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full h-11 bg-nexus-primary hover:bg-indigo-600 rounded-xl font-bold text-white transition disabled:opacity-50">{loading ? 'در حال بررسی...' : 'ورود'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const UsersPage = ({ serverStatus }) => {
            const [users, setUsers] = useState([]);
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'operator' });
            
            const loadUsers = useCallback(async () => { try { const res = await fetch(`${API_URL}/users`); if(res.ok) setUsers(await res.json()); } catch(e){} }, []);
            
            useEffect(() => { loadUsers(); }, [loadUsers]);
            
            // آیکون‌ها باید بعد از لود شدن کاربران یا تغییر در لیست رفرش شوند
            useLucide([users]);

            const handleAddUser = async () => {
                if(!newUser.username || !newUser.password) return alert("الزامی");
                try { if((await fetch(`${API_URL}/users/add`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(newUser) })).ok) { loadUsers(); setNewUser({username: '', password: '', role: 'operator'}); alert("انجام شد"); } else alert("خطا"); } catch(e) { alert("خطا"); }
            };
            const handleDeleteUser = async (id) => { if(confirm("حذف؟")) try { if((await fetch(`${API_URL}/users/delete/${id}`, {method: 'DELETE'})).ok) loadUsers(); } catch(e){} };
            
            return (
                <div className="flex-1 p-8 overflow-y-auto">
                    <header className="mb-8"><h2 className="text-2xl font-bold text-white">مدیریت کاربران</h2></header>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="glass-panel rounded-2xl p-6"><h3 className="text-lg font-bold mb-4 text-nexus-accent">لیست کاربران</h3><div className="space-y-2">{users.map(u => (<div key={u.id} className="flex justify-between items-center bg-white/5 p-3 rounded-lg"><div><span className="font-bold text-white ml-2">{u.username}</span><span className="text-xs text-gray-400 bg-white/5 px-2 py-1 rounded">{u.role === 'admin' ? 'مدیر' : 'اپراتور'}</span></div>{u.username !== 'admin' && (<button onClick={()=>handleDeleteUser(u.id)} disabled={!serverStatus} className="text-nexus-danger hover:bg-nexus-danger/20 p-2 rounded disabled:opacity-50"><i data-lucide="trash-2" className="w-5 h-5"></i></button>)}</div>))}</div></div>
                        <div className="glass-panel rounded-2xl p-6 h-fit"><h3 className="text-lg font-bold mb-4 text-nexus-success">افزودن کاربر</h3><div className="space-y-4"><NexusInput label="نام کاربری" value={newUser.username} onChange={e=>setNewUser({...newUser, username: e.target.value})} dir="ltr" disabled={!serverStatus} /><NexusInput label="رمز عبور" type="password" value={newUser.password} onChange={e=>setNewUser({...newUser, password: e.target.value})} dir="ltr" disabled={!serverStatus} /><div className="flex flex-col"><label className="text-gray-400 text-xs mb-1">سطح دسترسی</label><select value={newUser.role} onChange={e=>setNewUser({...newUser, role: e.target.value})} disabled={!serverStatus} className="nexus-input w-full px-3 py-2 text-sm"><option value="operator">اپراتور</option><option value="admin">مدیر</option></select></div><button onClick={handleAddUser} disabled={!serverStatus} className="w-full h-10 bg-nexus-primary hover:bg-indigo-600 rounded-lg font-bold text-white mt-2 disabled:opacity-50">افزودن</button></div></div>
                    </div>
                </div>
            );
        };

        const DashboardPage = ({ setView, role }) => {
            const items = [
                { title: "ورود قطعه", icon: "package-plus", color: "text-green-400", desc: "افزودن و ویرایش قطعات", view: "entry" },
                { title: "برداشت قطعه", icon: "arrow-down-circle", color: "text-red-400", desc: "ثبت خروج قطعات مصرفی", view: "withdraw" },
                { title: "موجودی انبار", icon: "bar-chart-2", color: "text-blue-400", desc: "گزارش‌گیری و آمار", view: "inventory" },
                { title: "تامین‌کنندگان", icon: "contact-2", color: "text-purple-400", desc: "مدیریت لیست فروشندگان", view: "contacts" },
                { title: "تاریخچه تراکنش‌ها", icon: "history", color: "text-amber-400", desc: "لاگ کامل خرید و ورود", view: "log", full: true }
            ];
            if (role === 'admin') items.push({ title: "مدیریت کاربران", icon: "users", color: "text-pink-400", desc: "تعریف کاربر و سطح دسترسی", view: "users" });
            
            // رندر آیکون‌ها فقط یکبار در زمان لود داشبورد
            useLucide([]);

            return (
                <div className="flex-1 p-8 overflow-y-auto">
                    <header className="mb-8"><h2 className="text-2xl font-bold text-white tracking-tight">داشبورد سیستم</h2></header>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-7xl mx-auto">{items.map((item, idx) => (<div key={idx} onClick={() => setView(item.view)} className={`cursor-pointer group relative overflow-hidden glass-panel hover:border-nexus-primary/50 rounded-2xl p-6 transition-all duration-300 hover:-translate-y-1 hover:shadow-[0_0_20px_rgba(99,102,241,0.15)] flex flex-col justify-between h-48 ${item.full ? 'col-span-1 md:col-span-2 lg:col-span-4' : ''}`}><div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-white/5 to-transparent rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div><div className="relative z-10"><div className={`w-12 h-12 rounded-xl flex items-center justify-center mb-4 bg-slate-800/50 group-hover:bg-nexus-primary/20 transition-colors border border-white/5`}><i data-lucide={item.icon} className={`w-6 h-6 ${item.color}`}></i></div><h3 className="text-xl font-bold text-white mb-1">{item.title}</h3><p className="text-gray-400 text-xs">{item.desc}</p></div></div>))}</div>
                </div>
            );
        };

        const EntryPage = ({ setView, serverStatus, user }) => {
            const [formData, setFormData] = useState({ id: null, val: "", unit: "R", watt: "", tol: "", pkg: "", type: "", date: getJalaliDate(), qty: "", price_toman: "", reason: "", min_qty: 1, vendor_name: "" });
            const [partsList, setPartsList] = useState([]);
            const [contacts, setContacts] = useState([]);
            const [searchVal, setSearchVal] = useState("");
            
            const rUnits = ["R", "k", "M"];
            const rWatts = ["1/8W", "1/4W", "1/2W", "1W", "2W", "3W", "5W", "10W", "20W"];
            const rTols = ["0.1%", "0.25%", "0.5%", "1%", "2%", "5%", "10%"];
            const rPkgs = ["0201", "0402", "0603", "0805", "1206", "1210", "2010", "2512", "Axial", "DIP"];
            const rTypes = ["General Purpose", "Precision", "Power", "High Voltage", "Current Sense", "Metal Film", "Carbon Film", "Wirewound", "Thin Film", "Thick Film"];

            const loadData = async () => { try { const [partsRes, contactsRes] = await Promise.all([fetch(`${API_URL}/parts`), fetch(`${API_URL}/contacts`)]); if(partsRes.ok) setPartsList(await partsRes.json()); if(contactsRes.ok) setContacts(await contactsRes.json()); } catch(e){} };
            useEffect(() => { loadData(); }, []);

            const filteredParts = useMemo(() => {
                const term = (searchVal || formData.val).toLowerCase().replace(/,/g, '');
                if (!term) return partsList;
                return partsList.filter(p => (p.val && p.val.toLowerCase().includes(term)) || (p.vendor_name && p.vendor_name.includes(term)));
            }, [partsList, searchVal, formData.val]);

            // **نکته مهندسی:** هر بار که لیست فیلتر شده تغییر کند (جستجو یا حذف)، آیکون‌ها باید مجدداً ساخته شوند
            useLucide([filteredParts]); 

            const handleChange = (key, val) => {
                let v = val;
                if (key === 'price_toman') v = formatNumberWithCommas(val.replace(/,/g, ''));
                setFormData(prev => ({ ...prev, [key]: v }));
            };

            const preventNonNumeric = (e) => {
                if (!/[0-9]/.test(e.key) && e.key !== "Backspace" && e.key !== "Delete" && e.key !== "ArrowLeft" && e.key !== "ArrowRight") {
                    e.preventDefault();
                }
            };

            const handleSubmit = async () => {
                if(!formData.val || !formData.qty) return alert("مقدار و تعداد الزامی است");
                const fullVal = formData.val + (formData.unit === "R" ? "" : formData.unit);
                const payload = { ...formData, val: fullVal, qty: Number(formData.qty) || 0, min_qty: Number(formData.min_qty) || 1, price: String(formData.price_toman).replace(/,/g, ''), username: user.username };
                try { if ((await fetch(`${API_URL}/save`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })).ok) { loadData(); setFormData({ ...formData, id: null, val: "", qty: "", price_toman: "", reason: "" }); alert("✅ ذخیره شد"); } } catch(e) { alert("❌ خطا"); }
            };
            
            const handleEdit = (p) => {
                let u = "R", v = p.val || "";
                if(v.endsWith("M")) { u="M"; v=v.slice(0,-1); } else if(v.endsWith("k")) { u="k"; v=v.slice(0,-1); } else if(v.endsWith("R")) { u="R"; v=v.slice(0,-1); }
                setFormData({ ...p, val: v, unit: u, tol: p.tolerance, pkg: p.package, date: p.buy_date, qty: p.quantity, price_toman: formatNumberWithCommas(p.toman_price), min_qty: p.min_quantity });
            };

            const handleDelete = async (id) => { if(confirm("حذف شود؟")) { try { await fetch(`${API_URL}/delete/${id}`, { method: 'DELETE' }); loadData(); } catch(e) {} } };

            return (
                <div className="flex-1 flex flex-col min-w-0 h-full">
                    <header className="h-16 border-b border-white/5 flex items-center justify-between px-6 bg-black/20 backdrop-blur-md">
                        <div className="relative w-80"><input className="nexus-input w-full px-4 py-2 pl-10 text-sm" placeholder="جستجو در انبار..." value={searchVal} onChange={e => setSearchVal(e.target.value)} /><i data-lucide="search" className="absolute right-3 top-2.5 w-4 h-4 text-gray-500"></i></div>
                        <div className="flex items-center gap-3"><span className="text-xs text-nexus-accent font-bold">تعداد قطعات موجود: {partsList.length}</span><div className="w-2 h-2 rounded-full bg-nexus-primary animate-pulse"></div></div>
                    </header>
                    <div className="flex-1 p-6 overflow-hidden">
                        <div className="h-full grid grid-cols-12 gap-6">
                            <div className="col-span-12 lg:col-span-8 flex flex-col h-full">
                                <div className="flex-1 glass-panel rounded-2xl overflow-hidden flex flex-col">
                                    <div className="grid grid-cols-12 gap-2 bg-black/30 p-3 border-b border-white/5 text-[11px] text-gray-400 font-bold text-center"><div className="col-span-1 text-right pr-2">ID</div><div className="col-span-6 text-right">مشخصات فنی</div><div className="col-span-1">تعداد</div><div className="col-span-2">قیمت</div><div className="col-span-2">عملیات</div></div>
                                    <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                        {filteredParts.map(p => (
                                            <div key={p.id} className={`grid grid-cols-12 gap-2 items-center p-3 rounded-lg border border-transparent hover:border-white/10 hover:bg-white/5 transition-all ${formData.id === p.id ? 'bg-nexus-primary/10 !border-nexus-primary/50' : ''}`}>
                                                <div className="col-span-1 text-right text-gray-500 text-[10px]">{p.id}</div>
                                                <div className="col-span-6 text-right flex flex-col justify-center gap-1">
                                                    <div className="flex items-center gap-2"><span className="text-white text-lg font-black ltr font-sans tracking-wide">{p.val}</span><span className="text-xs text-nexus-accent font-bold px-1.5 py-0.5 bg-nexus-accent/10 rounded">{p.package}</span></div>
                                                    <div className="flex flex-wrap gap-2 text-[10px] text-gray-400 items-center">{p.watt && <span className="flex items-center gap-1"><i data-lucide="zap" className="w-3 h-3 text-yellow-500"></i>{p.watt}</span>}{p.tolerance && <span className="flex items-center gap-1"><i data-lucide="percent" className="w-3 h-3 text-purple-400"></i>{p.tolerance}</span>}{p.type && <span className="text-gray-500 border-r border-gray-700 pr-2 mr-1">{p.type}</span>}</div>
                                                </div>
                                                <div className="col-span-1 text-center"><span className={`px-2 py-0.5 rounded text-xs font-bold ${p.quantity < p.min_quantity ? 'bg-red-500/20 text-red-400' : 'bg-emerald-500/20 text-emerald-400'}`}>{p.quantity}</span></div>
                                                <div className="col-span-2 text-center text-xs text-amber-400 ltr font-mono">{(p.toman_price||0).toLocaleString()}</div>
                                                <div className="col-span-2 flex justify-center gap-3">
                                                    <button onClick={(e) => { e.stopPropagation(); handleEdit(p); }} disabled={!serverStatus} title="ویرایش" className="w-9 h-9 rounded-full bg-nexus-primary/20 text-nexus-primary hover:bg-nexus-primary hover:text-white flex items-center justify-center transition-all shadow-lg hover:shadow-primary/50 disabled:opacity-30 disabled:cursor-not-allowed"><i data-lucide="pencil" className="w-5 h-5"></i></button>
                                                    <button onClick={(e) => { e.stopPropagation(); handleDelete(p.id); }} disabled={!serverStatus} title="حذف" className="w-9 h-9 rounded-full bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all disabled:opacity-30 disabled:cursor-not-allowed"><i data-lucide="trash-2" className="w-5 h-5"></i></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="col-span-12 lg:col-span-4 h-full">
                                <div className="glass-panel border-white/10 rounded-2xl p-5 h-full flex flex-col shadow-2xl relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-nexus-primary to-purple-600"></div>
                                    <h2 className="text-lg font-bold text-white mb-6 flex items-center justify-between"><span>{formData.id ? 'ویرایش قطعه' : 'ثبت قطعه جدید'}</span>{formData.id && <button onClick={() => setFormData({id: null, val: "", unit: "R", watt: "", tol: "", pkg: "", type: "", date: getJalaliDate(), qty: "", price_toman: "", reason: "", min_qty: 1, vendor_name: ""})} className="text-xs text-gray-400 hover:text-white bg-white/5 px-2 py-1 rounded transition">انصراف</button>}</h2>
                                    <div className="space-y-4 flex-1 overflow-y-auto pl-1 pr-1 custom-scroll">
                                        <div className="flex gap-3"><NexusInput label="مقدار (Value)" value={formData.val} onChange={e=>handleChange('val', e.target.value)} placeholder="مثلا 100" className="flex-1" disabled={!serverStatus} /><div className="w-20"><NexusSelect label="واحد" options={rUnits} value={formData.unit} onChange={e=>handleChange('unit', e.target.value)} disabled={!serverStatus} /></div></div>
                                        <div className="flex gap-3"><NexusSelect label="توان" options={rWatts} value={formData.watt} onChange={e=>handleChange('watt', e.target.value)} className="flex-1" disabled={!serverStatus} /><NexusSelect label="تولرانس" options={rTols} value={formData.tol} onChange={e=>handleChange('tol', e.target.value)} className="flex-1" disabled={!serverStatus} /></div>
                                        <div className="flex gap-3"><NexusSelect label="پکیج" options={rPkgs} value={formData.pkg} onChange={e=>handleChange('pkg', e.target.value)} className="flex-1" disabled={!serverStatus} /><NexusSelect label="نوع" options={rTypes} value={formData.type} onChange={e=>handleChange('type', e.target.value)} className="flex-1" disabled={!serverStatus} /></div>
                                        <div className="h-px bg-white/5 my-2"></div>
                                        <div className="flex gap-3">
                                            <NexusInput label="تعداد *" type="number" value={formData.qty} onChange={e=>handleChange('qty', e.target.value)} onKeyPress={preventNonNumeric} className="flex-1" disabled={!serverStatus} />
                                            <NexusInput label="حداقل" type="number" value={formData.min_qty} onChange={e=>handleChange('min_qty', e.target.value)} onKeyPress={preventNonNumeric} className="flex-1" disabled={!serverStatus} />
                                        </div>
                                        <NexusInput label="قیمت (تومان)" value={formData.price_toman} onChange={e=>handleChange('price_toman', e.target.value)} disabled={!serverStatus} />
                                        <div><NexusInput label="نام فروشنده" value={formData.vendor_name} onChange={e=>handleChange('vendor_name', e.target.value)} list="vendor-list" placeholder="انتخاب یا تایپ..." disabled={!serverStatus} /><datalist id="vendor-list">{contacts.map(c => <option key={c.id} value={c.name} />)}</datalist></div>
                                        <NexusInput label="پروژه / دلیل خرید" value={formData.reason} onChange={e=>handleChange('reason', e.target.value)} disabled={!serverStatus} />
                                    </div>
                                    <div className="mt-6 pt-4 border-t border-white/5"><button onClick={handleSubmit} disabled={!serverStatus} className={`w-full h-11 rounded-xl font-bold text-white shadow-lg transition-all flex items-center justify-center gap-2 ${formData.id ? 'bg-gradient-to-r from-orange-500 to-amber-600' : 'bg-gradient-to-r from-nexus-primary to-purple-600'} disabled:opacity-50`}>{serverStatus ? (formData.id ? 'ذخیره تغییرات' : 'ذخیره در انبار') : 'سرور قطع است'}</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ContactsPage = ({ serverStatus }) => {
            const [contacts, setContacts] = useState([]);
            const [newContact, setNewContact] = useState({ id: null, name: '', phone: '', mobile: '', fax: '', website: '', email: '', address: '', notes: '' });
            const loadContacts = async () => { try { const res = await fetch(`${API_URL}/contacts`); if (res.ok) setContacts(await res.json()); } catch (e) {} };
            useEffect(() => { loadContacts(); }, []);
            
            useLucide([contacts, newContact]);

            const handleSave = async () => { if (!newContact.name.trim()) return alert("نام الزامی است"); try { const res = await fetch(`${API_URL}/contacts/save`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(newContact) }); if (res.ok) { loadContacts(); setNewContact({id:null, name:'', phone:'', mobile:'', fax:'', website:'', email:'', address: '', notes:''}); } } catch (e) { alert("خطا"); } };
            const handleDelete = async (id) => { if(confirm("حذف؟")) try { if((await fetch(`${API_URL}/contacts/delete/${id}`, {method:'DELETE'})).ok) loadContacts(); } catch(e){} };

            return (
                <div className="flex-1 p-6 overflow-hidden flex flex-col h-full">
                    <header className="h-16 border-b border-white/5 flex items-center justify-between mb-4"><h2 className="text-lg font-bold text-white">مدیریت تامین‌کنندگان</h2></header>
                    <div className="flex-1 grid grid-cols-12 gap-6 min-h-0">
                        <div className="col-span-12 lg:col-span-8 glass-panel rounded-2xl flex flex-col overflow-hidden">
                            <div className="grid grid-cols-12 gap-2 bg-[#1e293b]/50 p-3 text-xs text-gray-400 font-bold border-b border-white/5"><div className="col-span-4">نام / وب‌سایت</div><div className="col-span-3 text-center">تماس</div><div className="col-span-3 text-center">آدرس / ایمیل</div><div className="col-span-2 text-center">عملیات</div></div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                {contacts.map(c => (
                                    <div key={c.id} onClick={() => setNewContact(c)} className={`grid grid-cols-12 gap-2 p-3 rounded-lg hover:bg-white/5 cursor-pointer items-center ${newContact.id === c.id ? 'bg-nexus-primary/10 border border-nexus-primary/50' : ''}`}>
                                        <div className="col-span-4 flex flex-col"><span className="font-bold text-white text-sm">{c.name}</span>{c.website && <a href={c.website.startsWith('http') ? c.website : `https://${c.website}`} target="_blank" onClick={e=>e.stopPropagation()} className="text-[10px] text-blue-400 hover:underline ltr text-left truncate">{c.website}</a>}</div>
                                        <div className="col-span-3 text-center flex flex-col gap-1 items-center justify-center">{c.mobile && <span className="text-xs ltr text-white bg-white/5 px-2 rounded-full">{c.mobile}</span>}{c.phone && <span className="text-[10px] ltr text-gray-400">{c.phone}</span>}</div>
                                        <div className="col-span-3 text-center flex flex-col gap-1 items-center justify-center">
                                            {c.address && <span className="text-[10px] text-gray-300 truncate max-w-[150px]">{c.address}</span>}
                                            {c.email && <span className="text-[10px] ltr text-gray-400 truncate max-w-[150px]">{c.email}</span>}
                                        </div>
                                        <div className="col-span-2 flex justify-center gap-2"><button onClick={(e) => { e.stopPropagation(); handleDelete(c.id); }} disabled={!serverStatus} className="text-nexus-danger hover:bg-nexus-danger/20 p-2 rounded-full transition-colors disabled:opacity-30"><i data-lucide="trash-2" className="w-5 h-5"></i></button></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="col-span-12 lg:col-span-4 glass-panel border border-white/10 rounded-2xl p-5 shadow-2xl h-fit">
                            <h2 className="text-lg font-bold text-white mb-4 flex justify-between">{newContact.id ? 'ویرایش' : 'افزودن'}{newContact.id && <button onClick={()=>setNewContact({id:null, name:'', phone:'', mobile:'', fax:'', website:'', email:'', address: '', notes:''})} className="text-xs bg-white/5 px-2 rounded hover:bg-white/10 transition">انصراف</button>}</h2>
                            <div className="space-y-3 custom-scroll overflow-y-auto max-h-[calc(100vh-250px)] pr-1">
                                <NexusInput label="نام *" value={newContact.name} onChange={e=>setNewContact(p=>({...p, name:e.target.value}))} disabled={!serverStatus} />
                                <div className="grid grid-cols-2 gap-2"><NexusInput label="موبایل" dir="ltr" value={newContact.mobile} onChange={e=>setNewContact(p=>({...p, mobile:e.target.value}))} disabled={!serverStatus} /><NexusInput label="تلفن" dir="ltr" value={newContact.phone} onChange={e=>setNewContact(p=>({...p, phone:e.target.value}))} disabled={!serverStatus} /></div>
                                <div className="grid grid-cols-2 gap-2"><NexusInput label="فکس" dir="ltr" value={newContact.fax} onChange={e=>setNewContact(p=>({...p, fax:e.target.value}))} disabled={!serverStatus} /><NexusInput label="وب‌سایت" dir="ltr" value={newContact.website} onChange={e=>setNewContact(p=>({...p, website:e.target.value}))} disabled={!serverStatus} /></div>
                                <NexusInput label="آدرس" value={newContact.address} onChange={e=>setNewContact(p=>({...p, address:e.target.value}))} disabled={!serverStatus} />
                                <NexusInput label="ایمیل" dir="ltr" value={newContact.email} onChange={e=>setNewContact(p=>({...p, email:e.target.value}))} disabled={!serverStatus} />
                                <div className="flex flex-col"><label className="text-gray-400 text-xs mb-1">یادداشت</label><textarea className="nexus-input p-2 h-20 resize-none" value={newContact.notes} onChange={e=>setNewContact(p=>({...p, notes:e.target.value}))} disabled={!serverStatus}></textarea></div>
                                <button onClick={handleSave} disabled={!serverStatus} className="w-full h-10 bg-nexus-primary hover:bg-indigo-600 rounded-lg font-bold text-white text-sm mt-2 transition disabled:opacity-50">ذخیره</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const LogPage = () => {
            const [logList, setLogList] = useState([]);
            useEffect(() => { fetch(`${API_URL}/log`).then(res => res.ok ? res.json() : []).then(setLogList).catch(console.error); }, []);
            
            useLucide([logList]);

            return (
                <div className="flex-1 p-6 overflow-hidden flex flex-col h-full">
                    <header className="h-16 flex items-center mb-4"><h2 className="text-lg font-bold text-white">گزارشات سیستم</h2></header>
                    <div className="flex-1 glass-panel rounded-2xl overflow-hidden flex flex-col">
                        <div className="grid grid-cols-12 gap-2 bg-[#1e293b]/50 p-3 text-xs text-gray-400 font-bold sticky top-0"><div className="col-span-1 text-center">ID</div><div className="col-span-2">کاربر</div><div className="col-span-2">قطعه</div><div className="col-span-2 text-center">عملیات</div><div className="col-span-1 text-center">تعداد</div><div className="col-span-2 text-center">فروشنده</div><div className="col-span-2 text-center">تاریخ</div></div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1">{logList.map(l => (<div key={l.log_id} className="grid grid-cols-12 gap-2 items-center p-3 rounded-lg hover:bg-white/5 border-b border-white/5 last:border-0 text-sm"><div className="col-span-1 text-center text-gray-600 text-xs">#{l.log_id}</div><div className="col-span-2 text-xs text-pink-400 font-mono">{l.username || 'unknown'}</div><div className="col-span-2 font-bold text-white ltr text-left">{l.val}</div><div className="col-span-2 text-center text-xs text-gray-400">{l.operation_type}</div><div className="col-span-1 text-center text-emerald-400 font-mono">{l.quantity_added > 0 ? `+${l.quantity_added}` : l.quantity_added}</div><div className="col-span-2 text-center text-blue-400 text-xs truncate">{l.vendor_name||'-'}</div><div className="col-span-2 text-center text-gray-500 text-xs flex flex-col"><span>{l.purchase_date}</span><span className="text-[10px] opacity-50">{l.timestamp}</span></div></div>))}</div>
                    </div>
                </div>
            );
        };

        const PlaceholderPage = ({ title }) => {
            useLucide([]);
            return (
                <div className="flex-1 flex flex-col items-center justify-center text-gray-500 gap-4"><i data-lucide="construction" className="w-16 h-16 opacity-50"></i><h2 className="text-xl font-bold text-gray-400">{title}</h2><p>این ماژول در حال توسعه است.</p></div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [serverStatus, setServerStatus] = useState(false);
            const [user, setUser] = useState(null); 

            useEffect(() => { 
                const check = () => fetch(`${API_URL}/heartbeat`, { method: 'POST' }).then(()=>setServerStatus(true)).catch(()=>setServerStatus(false));
                check();
                // پالس هر ۵ ثانیه: بهترین تعادل برای سرعت و پایداری
                const i = setInterval(check, 5000); 
                return () => clearInterval(i); 
            }, []);

            // تلاش برای ارسال سیگنال خروج (بهترین تلاش)
            useEffect(() => {
                const handleUnload = () => {
                    fetch(`${API_URL}/client_closed`, {
                        method: 'POST',
                        keepalive: true,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reason: 'unload' })
                    });
                };
                window.addEventListener('beforeunload', handleUnload);
                return () => window.removeEventListener('beforeunload', handleUnload);
            }, []);
            
            // این افکت کلی هم برای اطمینان بیشتر باقی می‌ماند
            useEffect(() => { setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 50); }, [activeTab, user]);
            
            const handleExit = () => { if (confirm("خروج از سیستم؟")) fetch(`${API_URL}/exit_app`, { method: 'POST' }).finally(() => window.close()); };
            const handleLogout = () => { setUser(null); setActiveTab('dashboard'); };

            if (!user) return <LoginPage onLogin={setUser} />;

            return (
                <div className="flex h-screen text-gray-300 font-sans">
                    <aside className="w-64 flex flex-col border-l border-white/5 bg-[#020617]/80 backdrop-blur-xl shrink-0 z-50">
                        <div className="h-20 flex flex-col items-center justify-center border-b border-white/5 gap-1"><h1 className="text-2xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">NEXUS</h1><div className="flex items-center gap-2 text-[10px] font-bold"><span className={`w-2 h-2 rounded-full ${serverStatus ? 'bg-nexus-success shadow-[0_0_8px_#10b981]' : 'bg-nexus-danger ping-slow'}`}></span><span className={serverStatus ? 'text-nexus-success' : 'text-nexus-danger'}>{serverStatus ? 'سرور متصل' : 'تلاش برای اتصال...'}</span></div></div>
                        <nav className="flex-1 p-4 space-y-2">
                            <div className="text-xs font-bold text-gray-500 px-4 mb-2 flex justify-between"><span>منوی اصلی</span><span className="text-nexus-accent">{user.username}</span></div>
                            <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'dashboard' ? 'bg-nexus-primary/10 text-nexus-primary border border-nexus-primary/20' : 'text-gray-400 hover:bg-white/5'}`}><i data-lucide="layout-grid" className="w-5 h-5"></i> داشبورد</button>
                            <button onClick={() => setActiveTab('entry')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'entry' ? 'bg-nexus-primary/10 text-nexus-primary border border-nexus-primary/20' : 'text-gray-400 hover:bg-white/5'}`}><i data-lucide="package-plus" className="w-5 h-5"></i> ورود قطعه</button>
                            {user.role === 'admin' && (<button onClick={() => setActiveTab('users')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'users' ? 'bg-nexus-primary/10 text-nexus-primary border border-nexus-primary/20' : 'text-gray-400 hover:bg-white/5'}`}><i data-lucide="users" className="w-5 h-5"></i> مدیریت کاربران</button>)}
                            <button onClick={() => setActiveTab('contacts')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'contacts' ? 'bg-nexus-primary/10 text-nexus-primary border border-nexus-primary/20' : 'text-gray-400 hover:bg-white/5'}`}><i data-lucide="contact-2" className="w-5 h-5"></i> تامین‌کنندگان</button>
                            <button onClick={() => setActiveTab('log')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'log' ? 'bg-nexus-primary/10 text-nexus-primary border border-nexus-primary/20' : 'text-gray-400 hover:bg-white/5'}`}><i data-lucide="history" className="w-5 h-5"></i> تاریخچه</button>
                        </nav>
                        <div className="p-4 border-t border-white/5 space-y-2">
                            <button onClick={handleLogout} className="flex items-center gap-2 text-gray-400 hover:text-white transition-colors text-sm px-4 w-full"><i data-lucide="log-out" className="w-4 h-4"></i> خروج از حساب</button>
                            <button onClick={handleExit} className="flex items-center gap-2 text-red-400 hover:text-red-300 transition-colors text-sm px-4 w-full"><i data-lucide="power" className="w-4 h-4"></i> بستن برنامه</button>
                        </div>
                    </aside>
                    <main className="flex-1 flex flex-col min-w-0 relative">
                        {activeTab === 'dashboard' && <DashboardPage setView={setActiveTab} role={user.role} />}
                        {activeTab === 'entry' && <EntryPage setView={setActiveTab} serverStatus={serverStatus} user={user} />}
                        {activeTab === 'users' && user.role === 'admin' && <UsersPage serverStatus={serverStatus} />}
                        {activeTab === 'contacts' && <ContactsPage serverStatus={serverStatus} />}
                        {activeTab === 'log' && <LogPage />}
                        {(activeTab === 'inventory' || activeTab === 'withdraw') && <PlaceholderPage title={activeTab === 'inventory' ? 'موجودی انبار' : 'برداشت قطعه'} />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>