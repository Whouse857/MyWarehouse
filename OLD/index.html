<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم انبارداری نکسوس</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        .gradient-text { background: linear-gradient(to right, #38bdf8, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .input-base { width: 100%; background-color: rgba(15, 23, 42, 0.5); border: 1px solid #334155; border-radius: 0.5rem; padding: 0.5rem 0.75rem; color: white; font-size: 0.875rem; transition: all 0.2s; }
        .input-base:focus { border-color: #6366f1; outline: none; ring: 1px #6366f1; }
        
        .symbol-box { width: 60px; height: 30px; background-repeat: no-repeat; background-position: center; background-size: contain; opacity: 0.8; }
        .symbol-resistor { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 40' stroke='%23a5b4fc' stroke-width='3' fill='none'%3E%3Cpath d='M0 20 L20 20 L25 5 L35 35 L45 5 L55 35 L65 5 L75 35 L80 20 L100 20' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); }
        .symbol-capacitor { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 40' stroke='%2394a3b8' stroke-width='3' fill='none'%3E%3Cpath d='M0 20 L42 20 M58 20 L100 20 M42 5 L42 35 M58 5 L58 35' stroke-linecap='round'/%3E%3C/svg%3E"); }
    </style>
    
    <script>
        tailwind.config = {
            theme: { extend: { colors: { bg: { main: '#0f172a', card: '#1e293b' }, primary: { 500: '#6366f1', 600: '#4f46e5' }, success: '#10b981', danger: '#ef4444', warning: '#f59e0b', }, boxShadow: { 'neon': '0 0 15px rgba(99, 102, 241, 0.2)' } } }
        }
    </script>
</head>
<body class="h-screen overflow-hidden flex flex-col selection:bg-primary-500 selection:text-white">
    <div id="root" class="h-full flex flex-col relative"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, memo, useRef } = React;
        const API_URL = "http://127.0.0.1:8090/api"; 
        const UPLOAD_BASE_URL = "http://127.0.0.1:8090"; // آدرس پایه برای نمایش عکس
        
        // --- توابع شمسی / میلادی (شبیه سازی) ---
        const getJalaliDate = () => {
            // شبیه سازی تاریخ شمسی امروز (به عنوان TEXT)
            return new Date().toLocaleDateString('fa-IR');
        };
        // ----------------------------------------

        // Componente Helper: اطمینان از رندر شدن آیکون‌ها
        const renderLucideIcons = () => {
            if (window.lucide) {
                const oldIcons = document.querySelectorAll('i[data-lucide]');
                oldIcons.forEach(icon => {
                    const svg = icon.querySelector('svg');
                    if (svg) icon.replaceChildren(); 
                });
                window.lucide.createIcons();
            }
        };

        // Components
        const InputGroup = memo(({ label, children, isRequired, hasError }) => (
            <div className="flex flex-col gap-1.5">
                <label className="text-xs font-bold text-gray-400 mr-1">
                    {label} {isRequired && <span className="text-danger">*</span>}
                </label>
                {/* اعمال کلاس border-danger اگر خطا وجود داشته باشد */}
                {React.Children.map(children, child => {
                    if (React.isValidElement(child)) {
                        return React.cloneElement(child, {
                            className: `${child.props.className || ''} ${hasError ? '!border-danger' : 'border-[#334155]'}`,
                        });
                    }
                    return child;
                })}
            </div>
        ));

        const StyledInput = memo((props) => {
            const isDateInput = props.isDate;
            const inputProps = {
                ...props,
                value: props.value || "",
                className: `input-base ${props.readOnly ? 'opacity-60 cursor-default' : ''}`,
                style: { textAlign: props.dir === 'ltr' ? 'left' : 'right' }
            };

            if (isDateInput) {
                // فیلد تاریخ (Text برای شمسی)
                return (
                    <div className="relative">
                        <input {...inputProps} type="text" placeholder="مثال: ۱۴۰۴/۰۹/۱۵" />
                        <i data-lucide="calendar" 
                           className="w-4 h-4 text-gray-500 absolute left-3 top-3 cursor-pointer"
                           // در اینجا می توانیم منطق فراخوانی تقویم شمسی را اضافه کنیم
                           onClick={(e) => {
                               // شبیه سازی: با کلیک روی آیکون، کاربر می تواند تاریخ را وارد کند
                               const newDate = prompt("لطفاً تاریخ شمسی را وارد کنید (مثال: ۱۴۰۴/۰۹/۱۵):", props.value);
                               if (newDate) {
                                   props.onChange({ target: { value: newDate } });
                               }
                           }}
                        ></i>
                    </div>
                );
            }

            return <input {...inputProps} />;
        });


        const StyledTextArea = memo((props) => (<textarea {...props} value={props.value || ""} className={`input-base resize-none ${props.readOnly ? 'opacity-60 cursor-default' : ''}`} rows="3" />));
        const StyledSelect = memo(({ options, ...props }) => (<div className="relative"><select {...props} value={props.value || ""} className="input-base appearance-none cursor-pointer"><option value="" className="bg-bg-card">انتخاب...</option>{options.map(opt => <option key={opt} value={opt} className="bg-bg-card">{opt}</option>)}</select><i data-lucide="chevron-down" className="absolute left-3 top-3 w-3 h-3 text-gray-500 pointer-events-none"></i></div>));

        // کامپوننت جدید برای نمایش و آپلود تصویر مقاومت
        const ResistorImage = memo(({ type, imagePath, onImageSelect }) => {
            const fileInputRef = useRef(null);
            const isUploading = imagePath && imagePath.startsWith('Uploading:');
            const fileName = isUploading ? imagePath.split(': ')[1] : (imagePath ? imagePath.split('/').pop() : '');

            // فراخوانی renderLucideIcons هنگام تغییر imagePath
            useEffect(() => {
                renderLucideIcons();
            }, [imagePath]);


            const imageDisplay = () => {
                if (isUploading) {
                    return (
                        <div className="flex flex-col items-center">
                            <i data-lucide="loader-2" className="w-8 h-8 text-warning mb-1 animate-spin"></i>
                            <span className="text-xs text-warning">در حال آپلود...</span>
                            <span className="text-xs text-warning break-all mt-1">{fileName}</span>
                        </div>
                    );
                }
                
                if (imagePath && imagePath.length > 0 && imagePath !== 'default') {
                    // نمایش تصویر واقعی از مسیر آپلودها
                    return (
                        <div className="w-full h-full p-1 relative">
                            <img 
                                src={`${UPLOAD_BASE_URL}/${imagePath}`} 
                                alt="Resistor Image" 
                                className="w-full h-full object-contain rounded max-h-[100px] mx-auto"
                                onError={(e) => { e.target.onerror = null; e.target.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ef4444' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='12' y1='8' x2='12' y2='12'%3E%3C/line%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'%3E%3C/line%3E%3C/svg%3E"; }}
                            />
                            <span className="text-xs text-success break-all mt-1 block truncate" title={fileName}>{fileName}</span>
                        </div>
                    );
                }
                
                // نمایش Placeholder بر اساس نوع
                let displayType = type || "default";
                switch (displayType) {
                    case 'Metal Film':
                        return <span className="text-sm font-light text-primary-400">تصویر مقاومت فیلم فلزی 

[Image of a metal film resistor]
</span>;
                    case 'Carbon Film':
                        return <span className="text-sm font-light text-primary-400">تصویر مقاومت فیلم کربن 

[Image of a carbon film resistor]
</span>;
                    case 'Wirewound':
                        return <span className="text-sm font-light text-primary-400">تصویر مقاومت سیمی (Wirewound)</span>;
                    case 'SMD/Chip':
                        return <span className="text-sm font-light text-primary-400">تصویر مقاومت چیپ (SMD)</span>;
                    default:
                        return <span className="text-sm font-light text-gray-500">جهت آپلود عکس کلیک کنید</span>;
                }
            };

            const handleBoxClick = () => {
                fileInputRef.current.click();
            };

            return (
                <div 
                    onClick={handleBoxClick} 
                    className="flex flex-col items-center justify-center p-3 h-full rounded-xl bg-white/5 border border-white/10 shadow-inner hover:bg-white/10 transition-colors cursor-pointer min-h-[120px]"
                    title="برای آپلود عکس کلیک کنید"
                >
                    <span className="text-xs text-gray-400 mb-1">نمای قطعه:</span>
                    {imageDisplay()}
                    
                    <input 
                        type="file" 
                        ref={fileInputRef} 
                        onChange={onImageSelect}
                        accept="image/*"
                        className="hidden"
                    />
                </div>
            );
        });

        // ... (بقیه MenuCard و TypeCard و MainMenu بدون تغییر) ...

        const MenuCard = memo(({ title, icon: IconName, color, desc, onClick, active }) => (
            <button onClick={onClick} className={`group relative h-64 glass hover:bg-bg-card/80 rounded-2xl p-6 text-right transition-all duration-300 hover:-translate-y-2 border-t-4 ${active ? 'border-t-success shadow-neon' : 'border-t-gray-700 hover:border-t-primary-500'}`}>
                <div className="relative z-10 h-full flex flex-col justify-between">
                    <div className={`w-14 h-14 rounded-xl flex items-center justify-center mb-4 ${color.replace('text-', 'bg-')}/20 ${color}`}><i data-lucide={IconName} className="w-7 h-7"></i></div>
                    <div><h3 className="text-2xl font-bold text-white mb-2">{title}</h3><p className="text-gray-400 text-xs">{desc}</p></div>
                    <div className="flex items-center text-sm font-bold mt-4 group-hover:translate-x-2 transition-transform text-success">انتخاب <i data-lucide="arrow-left" className="w-4 h-4 mr-2"></i></div>
                </div>
            </button>
        ));

        const TypeCard = memo(({ title, icon: IconName, color, disabled, onClick, symbolClass }) => (
            <button disabled={disabled} onClick={onClick} className={`group glass p-6 rounded-3xl flex flex-col items-center gap-4 transition-all duration-300 ${disabled ? 'opacity-50 grayscale cursor-not-allowed' : 'hover:bg-primary-500/20 hover:border-primary-500'}`}>
                <div className={`w-20 h-20 rounded-full flex items-center justify-center ${disabled ? 'bg-gray-700/50' : 'bg-primary-500/20 group-hover:bg-primary-500 group-hover:text-white'} transition-colors ${color}`}><i data-lucide={IconName} className="w-10 h-10"></i></div>
                <span className={`text-xl font-bold ${disabled ? 'text-gray-400' : 'text-white'}`}>{title}</span>
                {!disabled && <div className={`symbol-box ${symbolClass} mt-2`}></div>}
            </button>
        ));

        const MainMenu = ({ onNavigate, onExit }) => (
            <div className="h-full flex flex-col items-center justify-center p-8 relative z-10 bg-bg-main">
                <div className="text-center space-y-4 mb-12">
                    <div className="inline-flex p-4 rounded-2xl bg-white/5 border border-white/10 shadow-neon mb-2"><i data-lucide="layers" className="w-12 h-12 text-primary-500"></i></div>
                    <h1 className="text-4xl font-black text-white">سیستم انبار <span className="gradient-text">الکترونیک</span></h1>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-5xl">
                    <MenuCard title="برداشت قطعه" icon="arrow-down-circle" color="text-danger" desc="ثبت خروج قطعات مصرفی" onClick={() => onNavigate('withdraw')} />
                    <MenuCard title="ورود قطعه" icon="package-plus" color="text-success" desc="افزودن قطعات جدید به انبار" onClick={() => onNavigate('entry')} active />
                    <MenuCard title="موجودی انبار" icon="bar-chart-2" color="text-primary-500" desc="مشاهده لیست و آمارها" onClick={() => onNavigate('inventory')} />
                </div>
                <button onClick={onExit} className="absolute bottom-8 right-8 flex items-center gap-2 text-gray-500 hover:text-danger px-4 py-2 transition-all"><i data-lucide="power" className="w-5 h-5"></i> خروج</button>
            </div>
        );


        const EntryPage = ({ onBack }) => {
            const [selectedType, setSelectedType] = useState(null); 
            const [formData, setFormData] = useState({});
            const [partsList, setPartsList] = useState([]);
            const [searchVal, setSearchVal] = useState("");
            const [requiredErrors, setRequiredErrors] = useState({});
            const [imageFile, setImageFile] = useState(null); 
            
            const rUnits = useMemo(() => ["R", "k", "M"], []);
            const rWatts = useMemo(() => ["1/20W", "1/16W", "1/10W", "1/8W", "1/4W", "1/2W", "0.6W", "1W", "2W", "3W", "5W", "10W", "20W", "50W", "100W"], []);
            const rTols = useMemo(() => ["0.01%", "0.05%", "0.1%", "0.25%", "0.5%", "1%", "2%", "5%", "10%", "20%"], []);
            const rPkgs = useMemo(() => ["01005 (SMD)", "0201 (SMD)", "0402 (SMD)", "0603 (SMD)", "0805 (SMD)", "1206 (SMD)", "1210 (SMD)", "2010 (SMD)", "2512 (SMD)", "Axial-1/8W", "Axial-1/4W", "Axial-1/2W", "Axial-1W", "Axial-2W", "SIP", "DIP", "Cement", "Chassis"], []);
            const rTypes = useMemo(() => ["Carbon Film", "Metal Film", "Wirewound", "Thick Film", "Thin Film", "SMD/Chip", "Shunt", "Fussible"], []);


            const resetForm = useCallback(() => {
                const today = getJalaliDate();
                setFormData({ id: null, val: "", unit: "R", watt: "", tol: "", pkg: "", type: "", date: today, qty: "", price: "", reason: "", image_path: "" });
                setRequiredErrors({});
                setImageFile(null); 
            }, []);

            const loadParts = useCallback(async () => {
                try { 
                    const res = await fetch(`${API_URL}/parts`); 
                    if(res.ok) { const data = await res.json(); setPartsList(data); } 
                } catch(e) { setPartsList([]); }
            }, []);

            useEffect(() => { loadParts(); }, [loadParts]);
            useEffect(() => { if(selectedType === 'resistor') resetForm(); }, [selectedType, resetForm]);
            
            const filteredParts = useMemo(() => {
                return partsList.filter(p => {
                    const searchCriteria = (searchVal || formData.val || "").toLowerCase().replace(/,/g, '').replace(/r/g, '');
                    if (!searchCriteria) return true;
                    return p.val && p.val.toLowerCase().replace(/r/g, '').includes(searchCriteria);
                });
            }, [partsList, searchVal, formData.val]);

            useEffect(() => { setSearchVal(formData.val); }, [formData.val]);

            const checkRequiredFields = useCallback(() => {
                const requiredFields = { val: 'مقدار', qty: 'تعداد', reason: 'دلیل خرید' };
                let errors = {};
                let hasError = false;

                for (const key in requiredFields) {
                    const value = formData[key];
                    if (!value || (typeof value === 'string' && value.trim() === '')) {
                        errors[key] = true;
                        hasError = true;
                    }
                }
                setRequiredErrors(errors);
                return !hasError;
            }, [formData]);

            // --- آپلود عکس ---
            const handleImageSelect = (event) => {
                if (event.target.files.length > 0) {
                    const file = event.target.files[0];
                    setImageFile(file); 
                    setFormData(p => ({ ...p, image_path: `Uploading: ${file.name}` })); 
                }
            };
            
            const uploadImage = useCallback(async () => {
                if (!imageFile) return { success: true, path: formData.image_path };
                
                const uploadData = new FormData();
                uploadData.append('file', imageFile);
                
                try {
                    const res = await fetch(`${API_URL}/upload_image`, {
                        method: 'POST',
                        body: uploadData,
                    });
                    
                    if (res.ok) {
                        const result = await res.json();
                        return { success: true, path: result.path };
                    } else {
                        throw new Error(`Upload failed with status: ${res.status}`);
                    }
                } catch (e) {
                    alert(`خطا در آپلود عکس: ${e.message}`);
                    return { success: false, path: '' };
                }
            }, [imageFile, formData.image_path]);
            // ------------------


            const handleSubmit = useCallback(async () => {
                if (!checkRequiredFields()) { 
                    alert("لطفاً فیلدهای اجباری (*) را پر کنید.");
                    return; 
                }
                
                // 1. آپلود عکس قبل از ثبت اطلاعات اصلی
                const uploadResult = await uploadImage();
                if (!uploadResult.success && imageFile) return;
                
                const finalImagePath = uploadResult.path;


                const fullVal = formData.val + (formData.unit === "R" ? "" : formData.unit);
                
                // 2. ساخت payload برای ثبت/ویرایش قطعه
                const payload = { 
                    id: formData.id, val: fullVal, watt: formData.watt, tol: formData.tol,
                    pkg: formData.pkg, type: formData.type, date: formData.date,
                    qty: Number(formData.qty) || 0, 
                    price: formData.price ? formData.price.toString().replace(/,/g, '') : "",
                    reason: formData.reason,
                    image_path: finalImagePath 
                };
                
                // 3. ارسال داده های اصلی
                try { 
                    const res = await fetch(`${API_URL}/save`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
                    if (res.ok) { loadParts(); resetForm(); alert("ذخیره شد ✅"); } else { alert("خطا در ذخیره"); }
                } catch(e) { alert("خطا در ارتباط با سرور."); }
            }, [formData, loadParts, resetForm, checkRequiredFields, uploadImage, imageFile]);

            const handleDelete = useCallback(async (id) => {
                try {
                    const res = await fetch(`${API_URL}/delete/${id}`, { method: 'DELETE' });
                    if (res.ok) { loadParts(); alert(`قطعه ${id} حذف شد.`); } else { alert("خطا در حذف"); }
                } catch(e) { alert("خطا در حذف."); }
            }, [loadParts]);

            const handleEdit = useCallback((part) => {
                let u = "R", v = part.val || "";
                if(v.endsWith("M")) { u="M"; v=v.slice(0,-1); } else if(v.endsWith("k")) { u="k"; v=v.slice(0,-1); } else if(v.endsWith("R")) { u="R"; v=v.slice(0,-1); }
                
                const formattedPrice = (part.dollar_price !== null && part.dollar_price !== undefined) 
                    ? Number(part.dollar_price).toLocaleString() 
                    : "";
                
                const dateForInput = part.buy_date || getJalaliDate(); 

                setFormData({ 
                    id: part.id, val: v, unit: u, watt: part.watt, tol: part.tolerance, pkg: part.package, 
                    type: part.type, 
                    date: dateForInput, 
                    qty: part.quantity, 
                    price: formattedPrice,
                    reason: part.reason || "",
                    image_path: part.image_path || "" 
                });
                setRequiredErrors({}); 
                setImageFile(null);
            }, []);

            // **فراخوانی مجدد آیکون‌ها بعد از رندر شدن لیست قطعات فیلتر شده**
            useEffect(() => { 
                renderLucideIcons(); 
            }, [filteredParts, formData.id]); 

            // پاک کردن خطا به محض اینکه کاربر شروع به تایپ در فیلد کرد
            const handleChange = useCallback((key, value) => {
                setFormData(p => ({...p, [key]: value}));
                if (requiredErrors[key] && value.trim() !== '') {
                    setRequiredErrors(p => { delete p[key]; return {...p}; });
                }
            }, [requiredErrors]);


            if (!selectedType) return <div className="h-full flex items-center justify-center p-8 bg-bg-main"><div className="w-full max-w-4xl"><div className="flex items-center gap-4 mb-8"><button onClick={onBack} className="p-3 bg-white/5 hover:bg-white/10 rounded-xl transition text-white"><i data-lucide="arrow-right"></i></button><h2 className="text-3xl font-bold text-white">انتخاب نوع قطعه</h2></div><div className="grid grid-cols-2 md:grid-cols-4 gap-6"><TypeCard title="مقاومت" icon="zap" color="text-primary-500" symbolClass="symbol-resistor" onClick={() => setSelectedType('resistor')} />
                                <TypeCard title="خازن" icon="battery-charging" color="text-gray-500" symbolClass="symbol-capacitor" disabled />
                                <TypeCard title="سلف" icon="activity" color="text-gray-500" disabled />
                                <TypeCard title="آی‌سی" icon="cpu" color="text-gray-500" disabled />
                            </div></div></div>;

            return (
                <div className="h-full flex flex-col p-4 gap-4 bg-bg-main">
                    <div className="glass rounded-2xl p-6 border-t-4 border-t-primary-500">
                        <div className="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                            <div className="flex items-center gap-3"><div className="p-2 bg-primary-500/20 rounded-lg text-primary-400"><i data-lucide="plus-square" className="w-6 h-6"></i></div><h2 className="text-xl font-bold text-white flex items-center gap-2">{formData.id ? 'ویرایش مقاومت' : 'ورود مقاومت جدید'}<div className="symbol-box symbol-resistor ml-2"></div></h2></div>
                            <div className="flex gap-2">{formData.id && <button onClick={resetForm} className="px-3 py-1.5 bg-warning hover:bg-yellow-600 text-white text-xs rounded-lg transition">انصراف</button>}<button onClick={() => setSelectedType(null)} className="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs text-gray-300 transition">تغییر نوع</button></div>
                        </div>
                        <div className="grid grid-cols-12 gap-4 mb-6">
                            
                            {/* ردیف اول: مشخصات اصلی */}
                            <div className="col-span-2"><InputGroup label="مقدار" isRequired hasError={requiredErrors.val}><StyledInput dir="ltr" placeholder="100" value={formData.val} onChange={e => handleChange('val', e.target.value)} autoFocus /></InputGroup></div>
                            <div className="col-span-1"><InputGroup label="واحد"><StyledSelect dir="ltr" options={rUnits} value={formData.unit} onChange={e => handleChange('unit', e.target.value)} /></InputGroup></div>
                            <div className="col-span-2"><InputGroup label="توان"><StyledSelect dir="ltr" options={rWatts} value={formData.watt} onChange={e => handleChange('watt', e.target.value)} /></InputGroup></div>
                            <div className="col-span-2"><InputGroup label="تولرانس"><StyledSelect dir="ltr" options={rTols} value={formData.tol} onChange={e => handleChange('tol', e.target.value)} /></InputGroup></div>
                            <div className="col-span-2"><InputGroup label="پکیج"><StyledSelect dir="ltr" options={rPkgs} value={formData.pkg} onChange={e => handleChange('pkg', e.target.value)} /></InputGroup></div>
                            <div className="col-span-3"><InputGroup label="تعداد" isRequired hasError={requiredErrors.qty}><StyledInput type="number" dir="ltr" className="text-success font-bold" value={formData.qty} onChange={e => handleChange('qty', e.target.value)} /></InputGroup></div>
                            
                            {/* ردیف دوم: جزئیات مالی و تاریخ */}
                            <div className="col-span-3"><InputGroup label="نوع/جنس"><StyledSelect options={rTypes} value={formData.type} onChange={e => handleChange('type', e.target.value)} /></InputGroup></div>
                            <div className="col-span-3"><InputGroup label="قیمت واحد"><StyledInput dir="ltr" value={formData.price} onChange={e => { const r = e.target.value.replace(/,/g,''); if(!isNaN(r)) handleChange('price', Number(r).toLocaleString()) }} /></InputGroup></div>
                            
                            {/* فیلد تاریخ (شمسی) */}
                            <div className="col-span-3"><InputGroup label="تاریخ خرید"><StyledInput name="buy_date" isDate value={formData.date} onChange={e => handleChange('date', e.target.value)} /></InputGroup></div>
                            
                            {/* باکس نمایش و آپلود عکس */}
                            <div className="col-span-3 row-span-2">
                                <ResistorImage 
                                    type={formData.type} 
                                    imagePath={imageFile ? `Uploading: ${imageFile.name}` : formData.image_path}
                                    onImageSelect={handleImageSelect}
                                />
                            </div>

                            {/* ردیف دلیل خرید (عرض کامل) */}
                            <div className="col-span-9"><InputGroup label="دلیل خرید" isRequired hasError={requiredErrors.reason}><StyledTextArea value={formData.reason} onChange={e => handleChange('reason', e.target.value)} /></InputGroup></div>

                            {/* ردیف دکمه ثبت (در پایین‌ترین بخش) */}
                            <div className="col-span-12 flex items-end">
                                <button onClick={handleSubmit} className={`w-full py-2.5 rounded-xl font-bold text-white shadow-lg transition-all flex justify-center items-center gap-2 ${formData.id ? 'bg-warning hover:bg-yellow-600' : 'bg-success hover:bg-emerald-600'}`}><i data-lucide={formData.id ? "save" : "plus"} className="w-5 h-5"></i> {formData.id ? 'ذخیره تغییرات' : 'ثبت در انبار'}</button>
                            </div>
                        </div>
                    </div>
                    <div className="flex-1 glass rounded-2xl p-4 overflow-hidden flex flex-col">
                        <div className="text-sm font-bold text-gray-400 mb-3 flex justify-between"><span>موجودی فعلی انبار مقاومت‌ها</span><span>{filteredParts.length} رکورد</span></div>
                        <div className="flex-1 overflow-y-auto pr-2">
                            <table className="w-full text-sm border-collapse">
                                <thead className="sticky top-0 bg-[#1e293b] text-gray-400 text-xs"><tr>{['کد', 'مقدار', 'توان', 'خطا', 'پکیج', 'جنس', 'تعداد', 'قیمت', 'تاریخ', 'عکس', 'دلیل خرید', 'عملیات'].map(h => <th key={h} className="p-3 text-center border-b border-gray-700">{h}</th>)}</tr></thead>
                                <tbody className="text-gray-300">
                                    {filteredParts.map(p => (
                                        <tr 
                                            key={p.id} 
                                            className={`hover:bg-white/5 border-b border-gray-800 transition-colors ${formData.id === p.id ? 'bg-primary-500/10 border-l-4 border-l-primary-500' : 'cursor-default'}`}
                                        >
                                            <td className="p-3 text-center text-gray-500">{p.id}</td>
                                            <td className="p-3 text-center font-bold text-white ltr">{p.val}</td>
                                            <td className="p-3 text-center text-gray-400 text-sm ltr">{p.watt}</td>
                                            <td className="p-3 text-center ltr">{p.tolerance}</td>
                                            <td className="p-3 text-center text-primary-400 ltr">{p.package}</td>
                                            <td className="p-3 text-center text-gray-400">{p.type}</td>
                                            <td className="p-3 text-center font-bold text-success">{p.quantity}</td>
                                            
                                            <td className="p-3 text-center text-gray-400 ltr">
                                                {p.dollar_price ? Number(p.dollar_price).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 }) : '-'}
                                            </td>
                                            
                                            <td className="p-3 text-center text-gray-500 text-xs">{p.buy_date || '-'}</td>
                                            
                                            {/* نمایش وضعیت عکس در جدول */}
                                            <td className="p-3 text-center text-gray-500 text-xs max-w-[80px] overflow-hidden truncate">
                                                {p.image_path ? <i data-lucide="image" className="w-4 h-4 text-primary-400 mx-auto" title={p.image_path.split('/').pop()}></i> : '-'}
                                            </td>

                                            <td className="p-3 text-center text-gray-500 text-xs max-w-[150px] overflow-hidden truncate" title={p.reason}>{p.reason || '-'}</td>

                                            <td className="p-3 text-center flex items-center justify-center gap-2">
                                                <button 
                                                    onClick={e => { e.stopPropagation(); handleEdit(p); }} 
                                                    className="text-primary-400 hover:text-primary-500 transition p-1 rounded cursor-pointer"
                                                    title="ویرایش"
                                                >
                                                    <i data-lucide="pencil" className="w-4 h-4"></i>
                                                </button>
                                                
                                                <button 
                                                    onClick={e => { 
                                                        e.stopPropagation(); 
                                                        if (window.confirm(`آیا مطمئن هستید که می‌خواهید قطعه ${p.val} (کد ${p.id}) را حذف کنید؟`)) { 
                                                            handleDelete(p.id); 
                                                        } 
                                                    }} 
                                                    className="text-danger hover:text-red-600 transition p-1 rounded cursor-pointer"
                                                    title="حذف"
                                                >
                                                    <i data-lucide="trash-2" className="w-4 h-4"></i>
                                                </button>
                                            </td>
                                            
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const WithdrawPage = ({ onBack }) => <div className="h-full flex items-center justify-center p-8 bg-bg-main text-white"><button onClick={onBack} className="absolute top-8 right-8 p-3 bg-white/10 rounded-xl"><i data-lucide="arrow-right"></i></button>بخش برداشت (به زودی)</div>;
        const InventoryPage = ({ onBack }) => <div className="h-full flex items-center justify-center p-8 bg-bg-main text-white"><button onClick={onBack} className="absolute top-8 right-8 p-3 bg-white/10 rounded-xl"><i data-lucide="arrow-right"></i></button>بخش موجودی (به زودی)</div>;

        const App = () => {
            const [view, setView] = useState('menu'); 
            
            // Heartbeat Logic: Send "I am alive" every 1 second
            useEffect(() => { 
                const interval = setInterval(() => { 
                    fetch(`${API_URL}/heartbeat`, { method: 'POST' }).catch(() => {}); 
                }, 1000); 
                return () => clearInterval(interval); 
            }, []);
            
            // Immediate Exit on Window Close (Beacon)
            useEffect(() => {
                const handleBeforeUnload = () => {
                    fetch(`${API_URL}/exit_app`, { method: 'POST', keepalive: true }).catch(()=>{});
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, []);

            const handleExit = useCallback(() => {
                if (window.confirm("آیا مطمئن هستید که می‌خواهید برنامه را ببندید؟")) {
                    fetch(`${API_URL}/exit_app`, { method: 'POST' }).finally(() => window.close());
                }
            }, []);

            useEffect(() => { 
                renderLucideIcons(); 
            }); 
            
            switch (view) {
                case 'menu': return <MainMenu onNavigate={setView} onExit={handleExit} />;
                case 'withdraw': return <WithdrawPage onBack={() => setView('menu')} />;
                case 'entry': return <EntryPage onBack={() => setView('menu')} />;
                case 'inventory': return <InventoryPage onBack={() => setView('menu')} />;
                default: return <MainMenu onNavigate={setView} onExit={handleExit} />;
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>